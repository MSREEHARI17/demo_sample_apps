os: linux
dist: focal  # or use other Ubuntu versions like xenial or bionic

stages:
  - name: init
  - name: maven_build
  - name: sonar_analysis
  - name: docker_build_and_push
  - name: deploy_to_eks

cache:
  directories:
    - target

jobs:
  include:
    - stage: init
      script:
        # Install necessary tools on Ubuntu
        - sudo apt-get update -y
        - sudo apt-get install -y openjdk-11-jdk maven docker.io awscli
        # Install kubectl (Make sure to install the appropriate version)
        - sudo apt-get install -y apt-transport-https gnupg2 curl
        - curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
        - echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list
        - sudo apt-get update -y
        - sudo apt-get install -y kubectl

    - stage: maven_build
      script:
        - pwd
        - mvn clean package
        - ls -la
        - pwd
        - cd target
        - pwd
        - ls -la
        - mv target/spring-boot-mongo-1.3.jar $HOME/target-cache/spring-boot-mongo-1.3.jar

    - stage: sonar_analysis
      script:
        - mvn clean install sonar:sonar -Dsonar.organization=sreekantreddy -Dsonar.projectKey=sreekantreddy_travis-ci -Dsonar.host.url=https://sonarcloud.io -Dsonar.login=c64e9ce0ba777d04bedf1834303122c93faf6ad3
        
    - stage: docker_build_and_push
      script:
        - pwd
        - ls -la
        - mv $HOME/target-cache/spring-boot-mongo-1.3.jar target/spring-boot-mongo-1.3.jar
        - ls -la
        - docker build -t your-docker-image-name .
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker tag your-docker-image-name your-docker-registry/your-docker-image-name
        - docker push your-docker-registry/your-docker-image-name

    - stage: deploy_to_eks
      script:
        # Run EKS deployment commands here
        - kubectl apply -f eks-deployment.yaml
